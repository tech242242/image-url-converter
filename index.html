<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Image Compressor & Uploader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-text {
            background: linear-gradient(135deg, #60a5fa, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #3b82f6;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 text-white">

    <div class="glass-panel w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[500px]">
        
        <!-- Left: Upload & Info -->
        <div class="w-full md:w-1/2 p-8 border-b md:border-b-0 md:border-r border-slate-700 flex flex-col justify-center">
            <div class="mb-8">
                <h1 class="text-3xl font-bold tracking-tight mb-2">Image<span class="gradient-text">Lite</span></h1>
                <p class="text-slate-400 text-sm">Auto-compress to 150KB & Upload</p>
            </div>

            <div id="drop-zone" class="border-2 border-dashed border-slate-600 rounded-2xl p-10 text-center cursor-pointer hover:border-blue-500 hover:bg-slate-800/50 transition-all group relative overflow-hidden">
                <input type="file" id="image-input" class="hidden" accept="image/*">
                
                <div id="upload-content" class="relative z-10">
                    <div class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-400 group-hover:scale-110 transition-transform">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </div>
                    <h3 class="font-semibold text-lg">Upload Image</h3>
                    <p class="text-xs text-slate-500 mt-2">Drag & Drop or CTRL+V</p>
                </div>

                <!-- Processing Overlay -->
                <div id="processing-overlay" class="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center hidden">
                    <span class="loader mb-4"></span>
                    <p id="process-text" class="text-xs font-bold text-blue-400 uppercase tracking-widest">Compressing...</p>
                </div>
            </div>

            <!-- Stats -->
            <div id="stats-container" class="mt-8 grid grid-cols-2 gap-4 opacity-30 transition-opacity duration-500">
                <div class="stat-card p-4 rounded-xl">
                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Original</p>
                    <p id="size-original" class="text-xl font-mono mt-1">0 MB</p>
                </div>
                <div class="stat-card p-4 rounded-xl border-green-500/30 bg-green-500/5">
                    <p class="text-[10px] text-green-500 uppercase font-bold tracking-wider">Compressed</p>
                    <p id="size-compressed" class="text-xl font-mono mt-1 text-green-400">0 KB</p>
                </div>
            </div>
        </div>

        <!-- Right: Result & Preview -->
        <div class="w-full md:w-1/2 p-8 bg-slate-900/50 flex flex-col">
            <div class="flex-1 flex flex-col items-center justify-center relative">
                <div id="empty-state" class="text-center opacity-40">
                    <svg class="w-20 h-20 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <p class="font-medium text-slate-400">Optimized result will appear here</p>
                </div>
                
                <img id="preview-img" class="hidden max-w-full max-h-[350px] object-contain rounded-lg shadow-2xl border border-slate-700">
            </div>

            <div id="result-actions" class="mt-6 hidden">
                <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-bold text-blue-400 uppercase">Direct URL</span>
                        <span id="copy-msg" class="text-[10px] font-bold text-green-400 hidden">COPIED!</span>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="url-output" readonly class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:outline-none focus:border-blue-500">
                        <button onclick="copyToClipboard()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 rounded-lg text-xs font-bold transition-colors">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const TARGET_SIZE_KB = 150; // Target ~150KB
        const PUBLIC_KEY = "public_W8pXprjPHYrYwlWMf811dtUm2Og=";
        const PRIVATE_KEY = "private_Wu/w/ZEmydjv/FbRgVKOffRxtNY=";
        const ENDPOINT = "https://ik.imagekit.io/19imy4f1u";

        const dropZone = document.getElementById('drop-zone');
        const imgInput = document.getElementById('image-input');
        const processingOverlay = document.getElementById('processing-overlay');
        const processText = document.getElementById('process-text');
        
        // UI Elements
        const sizeOriginal = document.getElementById('size-original');
        const sizeCompressed = document.getElementById('size-compressed');
        const statsContainer = document.getElementById('stats-container');
        const previewImg = document.getElementById('preview-img');
        const emptyState = document.getElementById('empty-state');
        const resultActions = document.getElementById('result-actions');
        const urlOutput = document.getElementById('url-output');

        // Paste Event
        window.addEventListener('paste', e => {
            const file = e.clipboardData.files[0];
            if (file && file.type.startsWith('image/')) processPipeline(file);
        });

        // Click/Drop Events
        dropZone.onclick = () => imgInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); };
        dropZone.ondragleave = () => dropZone.classList.remove('border-blue-500');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            if(e.dataTransfer.files[0]) processPipeline(e.dataTransfer.files[0]);
        };
        imgInput.onchange = () => { if(imgInput.files[0]) processPipeline(imgInput.files[0]); };

        // Main Pipeline: Compress -> Upload -> Show
        async function processPipeline(file) {
            // Reset UI
            processingOverlay.classList.remove('hidden');
            processText.innerText = "Optimizing Size...";
            statsContainer.classList.remove('opacity-30');
            
            // Show Original Size
            sizeOriginal.innerText = formatBytes(file.size);

            try {
                // 1. Compress Image
                const compressedBlob = await compressImage(file);
                
                // Show New Size
                sizeCompressed.innerText = formatBytes(compressedBlob.size);
                processText.innerText = "Uploading to Cloud...";

                // 2. Upload to ImageKit
                const url = await uploadToImageKit(compressedBlob);
                
                // 3. Show Result
                showResult(url);

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            } finally {
                processingOverlay.classList.add('hidden');
            }
        }

        // --- Logic: Browser-side Compression ---
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Max Dimension Limit (e.g. 1920px) to help file size
                    const MAX_WIDTH = 1600; 
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Iterative Compression Logic
                    let quality = 0.9;
                    
                    const tryCompress = () => {
                        canvas.toBlob((blob) => {
                            if (!blob) return reject("Compression error");
                            
                            // Check if size is acceptable (<= 150KB) OR quality is too low
                            if (blob.size <= (TARGET_SIZE_KB * 1024) || quality <= 0.2) {
                                resolve(blob);
                            } else {
                                // Reduce quality and try again
                                quality -= 0.1;
                                tryCompress(); 
                            }
                        }, 'image/jpeg', quality);
                    };

                    tryCompress();
                };
                img.onerror = reject;
            });
        }

        // --- Logic: Upload ---
        async function uploadToImageKit(blob) {
            const formData = new FormData();
            formData.append('file', blob);
            formData.append('fileName', `compressed_${Date.now()}.jpg`);
            formData.append('publicKey', PUBLIC_KEY);

            const res = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
                method: 'POST',
                headers: { 'Authorization': 'Basic ' + btoa(PRIVATE_KEY + ':') },
                body: formData
            });

            const data = await res.json();
            if (!data.url) throw new Error("Upload Failed");
            return data.url;
        }

        function showResult(url) {
            emptyState.classList.add('hidden');
            previewImg.src = url;
            previewImg.classList.remove('hidden');
            resultActions.classList.remove('hidden');
            urlOutput.value = url;
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function copyToClipboard() {
            urlOutput.select();
            document.execCommand('copy');
            const msg = document.getElementById('copy-msg');
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 2000);
        }
    </script>
</body>
</html>
